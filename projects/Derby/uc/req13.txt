[DERBY-4963] Revert to FileDescriptor#sync from FileChannel#force to improve interrupt resilience [DERBY-4967] Handle interrupt received while waiting for database lock [DERBY-4968] Let query stop execution if an interrupt is seen, at same time as we check the query timeout  <p>FileChannel.force is interruptable, and we really don t want to be interrupted when we flush the log file.  Happily, on most platforms, we use the  rws / rwd  file open mask which makes the writes thjemselves synchronized, so no subsequent explicit file level sync is needed anyway.</p>

<p>DirFile4#getRandowmAccessFile should use plain DirRandomAccessFile instead of the current DirRandomAccessFile4. This will make StorageRandomAccessFile#sync map to FileDescriptor#sync instead of FileChannel#force (also for NIO supporting platforms). </p>

<p>Since FileDescriptor#sync does not allow synching file data only (it also synchronizes metadata), those platforms which do not support write synchronization will experience a performance drop, but this is the price we have to pay to survive interrupts without shutting down the database on those platforms. </p>

<p>Users which experience this as a problem, should update to a newer JVM which does support  rws / rwd  in the mode argument to java.io.RandomAccessFile (<a href= http://download.oracle.com/javase/6/docs/api/java/io/RandomAccessFile.html#RandomAccessFile(java.io.File,%20java.lang.String  class= external-link  rel= nofollow >http://download.oracle.com/javase/6/docs/api/java/io/RandomAccessFile.html#RandomAccessFile(java.io.File,%20java.lang.String</a>).</p>

<p>Cf. also discussion on <a href= https://issues.apache.org/jira/browse/DERBY-4741?focusedCommentId=12977862&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12977862  class= external-link  rel= nofollow >https://issues.apache.org/jira/browse/DERBY-4741?focusedCommentId=12977862&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#action_12977862</a> .</p> <p>Subtask of <a href= https://issues.apache.org/jira/browse/DERBY-4741  title= Make embedded Derby work reliably in the presence of thread interrupts  class= issue-link  data-issue-key= DERBY-4741 ><del>DERBY-4741</del></a>: this issue tracks the changes needed to handle interrupt received while a thread is waiting for a database lock.</p> <p>Subtask of <a href= https://issues.apache.org/jira/browse/DERBY-4741  title= Make embedded Derby work reliably in the presence of thread interrupts  class= issue-link  data-issue-key= DERBY-4741 ><del>DERBY-4741</del></a>. <br/>
In BasicNoPutResultSetImpl#checkCancellationFlag we currently check whether a statement has been canceled or it timed out at certain times during query execution. We would like an interrupt seen during execution hitherto to also throw at this point. Cf the way we also stop execution of batches if a batch element sees an interrupt.</p> 